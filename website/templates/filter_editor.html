<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', 'Segoe UI', 'Helvetica Neue', Tahoma, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: url('{{ url_for("static", filename="images/librarry.jpg") }}') no-repeat center center fixed;
      background-size: cover;
      overflow-y: auto;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(255, 255, 255, 0);
      backdrop-filter: blur(8px);
      z-index: -1;
    }

    .lang-switch {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1000;
    }

    .lang-switch a img {
        width: 26px;
        height: auto;
        margin-left: 8px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        transition: transform 0.2s ease;
    }

    .lang-switch a img:hover {
      transform: scale(1.3);
    }

    .form-container {
      margin: 60px auto;
      background: rgba({{ colors['sandstone_rgb'][0] }},
                       {{ colors['sandstone_rgb'][1] }},
                       {{ colors['sandstone_rgb'][2] }}, 0.8);
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      width: 650px;
      
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }

    input[type=text], select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #f9fbfd;
    }

    .grid-2-plain {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .made-by {
      margin-top: 60px;
      text-align: right;
      padding: 20px 30px;
      font-size: 12px;
      color: white;
      font-weight: normal;
    }

    .made-by a {
      color: white;
      font-weight: bold;
      text-decoration: none;
    }
    button.remove-keyword,
    button.remove-group,
    button.delete {
      padding: 4px 12px;
      font-size: 14px;
      background: {{ colors['brick'] }};
      color: white;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      height: 30px;
      margin-top: 2px;
      align-self: center;
    }

    button.add-keyword,
    #add-group-btn {
      background: {{ colors['dark_green'] }};
      color: white;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      padding: 8px 14px;
      margin-top: 10px;
      font-size: 14px;
    }

    .keyword-group {
      margin-bottom: 20px;
      padding: 10px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.5);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }

    .button-row {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }

    .wide-button {
      width: 140px;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      border: none;
      color: white;
      cursor: pointer;
    }

    .save-button {
      background: {{ colors['blue'] }};
    }

    .delete-button {
      background: {{ colors['brick'] }};
    }

    .results-box {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      font-size: 15px;
      line-height: 1.5;
    }

    .loading-text {
      margin-top: 15px;
      font-style: italic;
      color: #333;
    }

  </style>
</head>
<body>
  <div class="lang-switch">
        <a href="/lang/cz">
            <img src="{{ url_for('static', filename='images/cz_icon.png') }}" alt="CZ">
        </a>
        <a href="/lang/en">
            <img src="{{ url_for('static', filename='images/en_icon.png') }}" alt="EN">
        </a>
        <a href="/lang/es">
            <img src="{{ url_for('static', filename='images/es_icon.png') }}" alt="ES">
        </a>
    </div>

  <div class="form-container">
    <h2>{{ t("fe.edit_filter") + ": " + filter_name if filter_name else t("fe.create") }}</h2>
    <p style="margin-top: -10px; margin-bottom: 25px; font-size: 14px; color: #333;">
      {{ t("fe.description") }}
    </p>

    <form method="POST" id="filter-form">
      {% if not filter_name %}
      <label>{{ t("fe.name") }}</label>
      <input name="name" required>
      {% endif %}

      <label>{{ t("fe.keyword_groups") }}</label>
      <div id="keyword_groups">
        {% for i in range(6) %}
        {% set group = keyword_groups[i] %}
        {% if i == 0 or group %}
        <div class="keyword-group" data-group="{{ i }}">
          <label>{{ t("fe.group") }} {{ i+1 }}</label>
          <div class="keywords grid-2-plain">
            {% for kw in group %}
            <div style="display: flex; align-items: center; gap: 8px;">
              <input type="text" name="keyword_group_{{ i }}" value="{{ kw }}" required style="flex: 1;" class="keyword-input">
              <button type="button" class="remove-keyword">&times;</button>
            </div>
            {% endfor %}
          </div>
          <button type="button" class="add-keyword" data-group="{{ i }}">{{ t("fe.add_keyword") }}</button>
          <button type="button" class="remove-group">{{ t("fe.remove_group") }}</button>
        </div>
        {% endif %}
        {% endfor %}
      </div>
      <button type="button" id="add-group-btn">{{ t("fe.add_group") }}</button>

      <div class="button-row">
        <button type="submit" class="wide-button save-button">{{ t('fe.save') }}</button>
        <button type="button" id="check-filter-btn" class="wide-button save-button" style="background: {{ colors['dark_green'] }};">{{ t("fe.check_filter")}}</button>
      </div>
    </form>

    <div id="check-results" class="results-box" style="display: none; white-space: pre-line; margin-top: 20px; background: #fff; padding: 15px; border-radius: 8px;"></div>

    {% if filter_name %}
    <form method="POST" action="{{ url_for('editor.delete_filter', filter_name=filter_name) }}">
      <div class="button-row">
        <button type="submit" class="wide-button delete-button">{{ t("fe.delete_filter") }}</button>
      </div>
    </form>
    {% endif %}
    

    <h3 style="margin-bottom: 10px;">{{ t("fe.how_to_use") }}</h3>

    <div style="font-size: 14px; line-height: 1.6; color: #333;">
      <p>{{ t("fe.usage_guide.intro") }}</p>

      <ul>
        <li>{{ t("fe.usage_guide.match_logic") }}</li>
        <li>{{ t("fe.usage_guide.check_button") }}</li>
        <li>{{ t("fe.usage_guide.database_note") }}</li>
      </ul>

      <h4 style="margin-top: 1em;">{{ t("fe.examples") }}</h4>
      <p><strong>1. {{ t("fe.usage_guide.example_authors") }}</strong><br>
      Group 1: <code>Alice Smith</code>, <code>Bob Johnson</code>, <code>C. Zhang</code></p>

      <p><strong>2. {{ t("fe.usage_guide.example_category") }}</strong><br>
      Group 1: <code>cond-mat.mes-hall</code><br>
      Group 2: <code>quantum Hall</code></p>

      <p><strong>3. {{ t("fe.usage_guide.example_keywords") }}</strong><br>
      Group 1: <code>topological</code>, <code>topology</code><br>
      Group 2: <code>photonic</code>, <code>photonics</code><br>
      Group 3: <code>crystal</code>, <code>waveguide</code>, <code>interface</code></p>
      
      <div style="margin-top: 15px;">
        <p style="color: {{ colors['dark'] }}; font-weight: bold;">{{ t("fe.usage_guide.warning_title") }}</p>
        <p style="color: {{ colors['dark'] }};">
          {{ t("fe.usage_guide.warning_body") }}
        </p>
      </div>

      <p>{{ t("fe.usage_guide.download_categories") }}</p>
    </div>
    <div class="button-row">
      <a href="{{ url_for('static', filename='categories.txt') }}" download>
        <button type="button" class="wide-button save-button">
          {{ t("fe.download_categories") }}
        </button>
      </a>
    </div>
  </div>

  <div class="made-by">
    Made by <a href="http://65.108.244.193:5002/" target="_blank">Ondřej Novák</a>
  </div>
  <script>
    const translation = {
      found: "{{ t('fe.found') }}",
      matches: "{{ t('fe.matches') }}",
      examples: "{{ t('fe.examples') }}"
    };
  </script>
  <script>
    // --- Add/remove keyword/group functionality ---
    document.querySelectorAll('.add-keyword').forEach(btn => {
      btn.addEventListener('click', function () {
        const groupIndex = this.getAttribute('data-group');
        const keywordsDiv = this.parentElement.querySelector('.keywords');
        if (keywordsDiv.children.length >= 10) return;

        const kwDiv = document.createElement('div');
        kwDiv.style.display = 'flex';
        kwDiv.style.alignItems = 'center';
        kwDiv.style.gap = '8px';
        kwDiv.innerHTML = `<input type="text" name="keyword_group_${groupIndex}" required style="flex: 1;" class="keyword-input">
          <button type="button" class="remove-keyword">&times;</button>`;
        keywordsDiv.appendChild(kwDiv);
        kwDiv.querySelector('.remove-keyword').addEventListener('click', () => kwDiv.remove());
      });
    });

    document.querySelectorAll('.remove-keyword').forEach(btn => {
      btn.addEventListener('click', () => btn.parentElement.remove());
    });

    document.querySelectorAll('.remove-group').forEach(btn => {
      btn.addEventListener('click', () => btn.parentElement.remove());
    });

    document.getElementById('add-group-btn').addEventListener('click', function () {
      const container = document.getElementById('keyword_groups');
      const currentGroups = container.querySelectorAll('.keyword-group');
      if (currentGroups.length >= 6) return;

      const i = currentGroups.length;
      const group = document.createElement('div');
      group.className = 'keyword-group';
      group.setAttribute('data-group', i);
      group.innerHTML = `
        <label>{{ t("fe.group") }} ${i+1}</label>
        <div class="keywords grid-2-plain"></div>
        <button type="button" class="add-keyword" data-group="${i}">{{ t("fe.add_keyword") }}</button>
        <button type="button" class="remove-group">{{ t("fe.remove_group") }}</button>
      `;
      container.appendChild(group);

      group.querySelector('.add-keyword').addEventListener('click', function () {
        const keywordsDiv = group.querySelector('.keywords');
        if (keywordsDiv.children.length >= 10) return;
        const kwDiv = document.createElement('div');
        kwDiv.style.display = 'flex';
        kwDiv.style.alignItems = 'center';
        kwDiv.style.gap = '8px';
        kwDiv.innerHTML = `<input type="text" name="keyword_group_${i}" required style="flex: 1;" class="keyword-input">
          <button type="button" class="remove-keyword">&times;</button>`;
        keywordsDiv.appendChild(kwDiv);
        kwDiv.querySelector('.remove-keyword').addEventListener('click', () => kwDiv.remove());
      });

      group.querySelector('.remove-group').addEventListener('click', () => group.remove());
    });

    // --- Check filter via FormData (form-style POST) ---
    document.getElementById('check-filter-btn').addEventListener('click', async () => {
      const form = document.getElementById("filter-form");
      const formData = new FormData(form);

      const resultsDiv = document.getElementById('check-results');
      resultsDiv.style.display = 'block';
      resultsDiv.textContent = "Checking...";

      try {
        const response = await fetch("/filters/check", {
          method: "POST",
          body: formData
        });

        if (!response.ok) {
          resultsDiv.textContent = "❌ Failed to check filter (server error)";
          return;
        }

        const data = await response.json();
        const lines = [`✅ ${translation.found} ${data.matches} ${translation.matches}`];
        if (data.titles.length > 0) {
          lines.push(`${translation.examples}:`);
          data.titles.forEach(t => lines.push(`‣ ${t}`));
        }

        resultsDiv.textContent = lines.join('\n');
      } catch (error) {
        resultsDiv.textContent = "❌ Failed to check filter (network error)";
        console.error("Check filter error:", error);
      }
    });
    
  </script>

  
</body>
</html>